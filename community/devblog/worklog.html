<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Work Log</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121932; --muted:#94a3b8; --text:#e6edf3; --accent:#7c9aff; --accent-2:#4ade80; --danger:#ef4444;
      --ring:0 0 0 2px color-mix(in oklab, var(--accent) 55%, transparent);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#f7f8fb; --card:#ffffff; --muted:#475569; --text:#0f172a; --accent:#3b82f6; --accent-2:#16a34a; --danger:#dc2626; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,color-mix(in oklab,var(--accent) 12%,transparent),transparent),
                  radial-gradient(1200px 800px at 110% 10%,color-mix(in oklab,var(--accent-2) 10%,transparent),transparent),
                  var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;line-height:1.35}
    header{position:sticky;top:0;z-index:10;background:color-mix(in oklab,var(--bg) 85%, transparent);backdrop-filter:saturate(110%) blur(6px);border-bottom:1px solid color-mix(in oklab,var(--text) 12%, transparent)}
    .wrap{max-width:1100px;margin-inline:auto;padding:16px}
    h1{margin:0;font-size:clamp(1.2rem,2.5vw,1.6rem)}
    .grid{display:grid;gap:12px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .card{background:linear-gradient(180deg,color-mix(in oklab,var(--card) 96%, transparent), color-mix(in oklab,var(--card) 96%, transparent));border:1px solid color-mix(in oklab,var(--text) 10%, transparent);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
    form#entry{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:10px;padding:14px}
    form#entry > *{min-width:0}
    .col-2{grid-column:span 2}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-12{grid-column:span 12}
    label{display:block;font-size:.8rem;color:var(--muted);margin-bottom:4px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid color-mix(in oklab,var(--text) 14%, transparent);background:color-mix(in oklab,var(--card) 96%, transparent);color:var(--text)}
    input::placeholder,textarea::placeholder{color:color-mix(in oklab,var(--muted) 70%, transparent)}
    textarea{resize:vertical;min-height:42px}
    .btn{cursor:pointer;border:1px solid color-mix(in oklab,var(--text) 16%, transparent);border-radius:12px;padding:10px 14px;background:linear-gradient(180deg,color-mix(in oklab,var(--accent) 22%, transparent),color-mix(in oklab,var(--accent) 10%, transparent));color:var(--text);font-weight:600}
    .btn.alt{background:transparent}
    .btn.danger{background:transparent;border-color:color-mix(in oklab,var(--danger) 70%, transparent);color:var(--danger)}
    .btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid color-mix(in oklab,var(--text) 12%, transparent);border-radius:999px;background:color-mix(in oklab,var(--card) 96%, transparent);font-size:.85rem}
    .muted{color:var(--muted)}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px}
    .toolbar .spacer{flex:1}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:.8rem;text-align:left;color:var(--muted);font-weight:600}
    tbody td, thead th{padding:10px 12px}
    tbody tr{background:color-mix(in oklab,var(--card) 96%, transparent);border:1px solid color-mix(in oklab,var(--text) 10%, transparent)}
    tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    tbody td.actions{white-space:nowrap}
    tbody .status{font-weight:600}

    .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-top:1px solid color-mix(in oklab,var(--text) 10%, transparent)}
    .totals{font-weight:700}

    .hint{font-size:.9rem}

    @media (max-width:900px){
      .col-2,.col-3,.col-4,.col-6{grid-column:span 12}
      thead{display:none}
      tbody tr{display:grid;grid-template-columns:repeat(12,1fr)}
      tbody td{grid-column:span 12;padding:8px 12px}
      tbody td[data-label]::before{content:attr(data-label) ": ";color:var(--muted);font-weight:600}
      tbody td.actions{display:flex;gap:8px}
    }
    @media print{
      header,.toolbar,.controls,.footer{display:none !important}
      body{background:#fff;color:#000}
      .card{box-shadow:none;border:1px solid #ccc}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Work Log</h1>
      <div class="bar">
        <span class="pill" title="Auto-saved locally">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm-1 15-5-5 1.414-1.414L11 13.172l6.586-6.586L19 8Z"/></svg>
          Local autosave
        </span>
        <span id="today" class="muted"></span>
      </div>
    </div>
  </header>

  <main class="wrap grid" style="gap:16px;margin-top:10px">

    <!-- Entry form -->
    <section class="card" aria-labelledby="entry-title">
      <form id="entry" class="grid" autocomplete="off">
        <h2 id="entry-title" class="col-12" style="margin:6px 0 0 2px;font-size:1rem">Add / Edit Entry</h2>
        <div class="col-3">
          <label for="date">Date</label>
          <input id="date" type="date" required />
        </div>
        <div class="col-2">
          <label for="start">Start</label>
          <input id="start" type="time" />
        </div>
        <div class="col-2">
          <label for="end">End</label>
          <input id="end" type="time" />
        </div>
        <div class="col-2">
          <label for="hours">Hours (decimal)</label>
          <input id="hours" type="number" step="0.01" min="0" placeholder="e.g. 1.5" />
        </div>
        <div class="col-3">
          <label for="project">Project</label>
          <input id="project" type="text" placeholder="Site / client / repo" />
        </div>
        <div class="col-6">
          <label for="task">Task</label>
          <input id="task" type="text" placeholder="What did you do?" />
        </div>
        <div class="col-3">
          <label for="status">Status</label>
          <select id="status">
            <option>Done</option>
            <option>In Progress</option>
            <option>Blocked</option>
            <option>Planned</option>
          </select>
        </div>
        <div class="col-3">
          <label for="tags">Tags</label>
          <input id="tags" type="text" placeholder="comma,separated" />
        </div>
        <div class="col-12">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Optional details, links, PR #, ticket, etc."></textarea>
        </div>
        <div class="col-12 bar" style="justify-content:flex-end">
          <button type="reset" class="btn alt" id="cancelEdit" hidden>Cancel edit</button>
          <button class="btn" id="save">Save entry</button>
        </div>
        <input type="hidden" id="rowId" />
      </form>
    </section>

    <!-- Toolbar / filters -->
    <section class="card">
      <div class="toolbar">
        <div class="controls" style="display:flex;gap:10px;flex-wrap:wrap">
          <input id="q" type="search" placeholder="Search task, notes, tags…" aria-label="Search" />
          <input id="from" type="date" aria-label="From" />
          <input id="to" type="date" aria-label="To" />
          <select id="projectFilter" aria-label="Project filter">
            <option value="">All projects</option>
          </select>
          <select id="statusFilter" aria-label="Status filter">
            <option value="">All status</option>
            <option>Done</option>
            <option>In Progress</option>
            <option>Blocked</option>
            <option>Planned</option>
          </select>
        </div>
        <span class="spacer"></span>
        <div class="controls" style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn alt" id="exportCsv" title="Export CSV">Export CSV</button>
          <button class="btn alt" id="exportJson" title="Export JSON">Export JSON</button>
          <label class="btn alt" for="importJson" title="Import JSON" style="display:inline-flex;align-items:center;gap:8px;cursor:pointer">
            <input id="importJson" type="file" accept="application/json" hidden />Import JSON
          </label>
          <button class="btn danger" id="clearAll" title="Clear all">Clear all</button>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="card" aria-live="polite">
      <div style="overflow:auto;padding:6px 6px 0">
        <table id="table">
          <thead>
            <tr>
              <th data-sort="date">Date</th>
              <th data-sort="hours">Hours</th>
              <th data-sort="project">Project</th>
              <th data-sort="task">Task</th>
              <th>Notes</th>
              <th data-sort="status">Status</th>
              <th>Tags</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footer">
        <div class="muted hint">Tip: Fill Start/End to auto-calc hours. Use filters to narrow view.</div>
        <div class="totals"><span id="count">0</span> entries • <span id="sum">0.00</span> hours</div>
      </div>
    </section>

  </main>

  <template id="row-tpl">
    <tr>
      <td data-label="Date"></td>
      <td data-label="Hours"></td>
      <td data-label="Project"></td>
      <td data-label="Task"></td>
      <td data-label="Notes"></td>
      <td data-label="Status" class="status"></td>
      <td data-label="Tags"></td>
      <td class="actions"></td>
    </tr>
  </template>

  <script>
  ;(() => {
    const $ = (id) => document.getElementById(id)
    const fmt = new Intl.NumberFormat(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})
    const STORAGE_KEY = 'worklog_v1'

    const state = {
      entries: [],
      sort: { key: 'date', dir: 'desc' },
      filters: { q:'', from:'', to:'', project:'', status:'' },
    }

    // Initialize
    const today = new Date()
    $('today').textContent = today.toLocaleDateString(undefined, {weekday:'short', year:'numeric', month:'short', day:'numeric'})
    $('date').valueAsDate = today

    // Load from localStorage
    try {
      const raw = localStorage.getItem(STORAGE_KEY)
      if (raw) state.entries = JSON.parse(raw)
    } catch(e){ console.warn('load failed', e) }

    // Elements
    const tbody = $('tbody')
    const rowTpl = $('row-tpl')

    // Helpers
    const saveLocal = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entries))
    const uid = () => Math.random().toString(36).slice(2,9)

    function timeToHours(t){
      if(!t) return 0
      const [h,m] = t.split(':').map(Number)
      return h + (m||0)/60
    }

    function calcHours(){
      const s = $('start').value, e = $('end').value
      if(s && e){
        let h = timeToHours(e) - timeToHours(s)
        if(h < 0) h += 24 // overnight
        $('hours').value = Math.round(h*100)/100
      }
    }
    $('start').addEventListener('change', calcHours)
    $('end').addEventListener('change', calcHours)

    function applyFilters(list){
      const {q, from, to, project, status} = state.filters
      const ql = q.trim().toLowerCase()
      return list.filter(x => {
        if (from && x.date < from) return false
        if (to && x.date > to) return false
        if (project && x.project !== project) return false
        if (status && x.status !== status) return false
        if (ql){
          const hay = [x.task, x.notes, x.tags].join(' ').toLowerCase()
          if (!hay.includes(ql)) return false
        }
        return true
      })
    }

    function sortBy(list){
      const {key, dir} = state.sort
      const sign = dir === 'asc' ? 1 : -1
      return [...list].sort((a,b) => {
        if (key === 'hours') return sign * (a.hours - b.hours)
        const va = (a[key]||'').toString().toLowerCase()
        const vb = (b[key]||'').toString().toLowerCase()
        return sign * va.localeCompare(vb, undefined, {numeric:true})
      })
    }

    function refreshProjects(){
      const sel = $('projectFilter')
      const cur = sel.value
      const projects = Array.from(new Set(state.entries.map(e => e.project).filter(Boolean))).sort()
      sel.innerHTML = '<option value="">All projects</option>' + projects.map(p=>`<option>${p}</option>`).join('')
      if(projects.includes(cur)) sel.value = cur
    }

    function render(){
      const filtered = applyFilters(state.entries)
      const rows = sortBy(filtered)
      tbody.innerHTML = ''
      for(const x of rows){
        const tr = rowTpl.content.firstElementChild.cloneNode(true)
        const cells = tr.children
        cells[0].textContent = x.date
        cells[1].textContent = x.hours.toFixed(2)
        cells[2].textContent = x.project
        cells[3].textContent = x.task
        cells[4].textContent = x.notes
        cells[5].textContent = x.status
        cells[6].textContent = x.tags
        const act = document.createElement('div')
        act.style.display='flex'; act.style.gap='6px'
        const b1 = document.createElement('button'); b1.textContent='Edit'; b1.className='btn alt'; b1.addEventListener('click',()=>editEntry(x.id))
        const b2 = document.createElement('button'); b2.textContent='Delete'; b2.className='btn danger'; b2.addEventListener('click',()=>delEntry(x.id))
        act.append(b1,b2)
        cells[7].className = 'actions'
        cells[7].append(act)
        tbody.append(tr)
      }
      const total = rows.reduce((s,x)=>s+x.hours,0)
      $('count').textContent = rows.length
      $('sum').textContent = fmt.format(total)
      refreshProjects()
    }

    function resetForm(){
      $('entry').reset(); $('rowId').value=''; $('cancelEdit').hidden = true
      $('date').valueAsDate = new Date()
    }

    function collectForm(){
      const id = $('rowId').value || uid()
      const date = $('date').value
      const start = $('start').value
      const end = $('end').value
      let hours = parseFloat($('hours').value)
      if (!isFinite(hours)){
        if(start && end){ hours = timeToHours(end) - timeToHours(start); if(hours<0) hours += 24 }
        else hours = 0
      }
      return {
        id,
        date,
        start,
        end,
        hours: Math.round(hours*100)/100,
        project: $('project').value.trim(),
        task: $('task').value.trim(),
        status: $('status').value,
        tags: $('tags').value.trim(),
        notes: $('notes').value.trim()
      }
    }

    function upsertEntry(entry){
      const i = state.entries.findIndex(e=>e.id===entry.id)
      if(i>=0) state.entries[i] = entry
      else state.entries.push(entry)
      saveLocal(); render(); resetForm()
    }

    function editEntry(id){
      const x = state.entries.find(e=>e.id===id); if(!x) return
      $('rowId').value = x.id
      $('date').value = x.date
      $('start').value = x.start
      $('end').value = x.end
      $('hours').value = x.hours
      $('project').value = x.project
      $('task').value = x.task
      $('status').value = x.status
      $('tags').value = x.tags
      $('notes').value = x.notes
      $('cancelEdit').hidden = false
      window.scrollTo({top:0,behavior:'smooth'})
    }

    function delEntry(id){
      if(!confirm('Delete this entry?')) return
      state.entries = state.entries.filter(e=>e.id!==id)
      saveLocal(); render()
    }

    // Sorting
    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.style.cursor='pointer'
      th.title='Click to sort'
      th.addEventListener('click', ()=>{
        const key = th.dataset.sort
        if(state.sort.key === key){ state.sort.dir = state.sort.dir==='asc'?'desc':'asc' }
        else { state.sort.key = key; state.sort.dir='asc' }
        render()
      })
    })

    // Filters
    $('q').addEventListener('input', e=>{ state.filters.q = e.target.value; render() })
    $('from').addEventListener('change', e=>{ state.filters.from = e.target.value; render() })
    $('to').addEventListener('change', e=>{ state.filters.to = e.target.value; render() })
    $('projectFilter').addEventListener('change', e=>{ state.filters.project = e.target.value; render() })
    $('statusFilter').addEventListener('change', e=>{ state.filters.status = e.target.value; render() })

    // Save
    $('save').addEventListener('click', (e)=>{
      e.preventDefault()
      const entry = collectForm()
      if(!entry.date){ alert('Please pick a date.'); return }
      if(!entry.hours || entry.hours<0){ if(!confirm('Hours are zero. Save anyway?')) return }
      upsertEntry(entry)
    })

    $('cancelEdit').addEventListener('click', (e)=>{ e.preventDefault(); resetForm() })

    // Export CSV
    $('exportCsv').addEventListener('click', ()=>{
      const rows = ['id,date,start,end,hours,project,task,status,tags,notes']
      for(const x of applyFilters(state.entries)){
        const esc = s => '"' + String(s??'').replaceAll('"','""') + '"'
        rows.push([x.id,x.date,x.start,x.end,x.hours,x.project,x.task,x.status,x.tags,x.notes].map(esc).join(','))
      }
      const blob = new Blob([rows.join('\n')], {type:'text/csv'})
      const a = Object.assign(document.createElement('a'), {download:`worklog-${new Date().toISOString().slice(0,10)}.csv`, href:URL.createObjectURL(blob)})
      a.click(); URL.revokeObjectURL(a.href)
    })

    // Export JSON
    $('exportJson').addEventListener('click', ()=>{
      const data = applyFilters(state.entries)
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'})
      const a = Object.assign(document.createElement('a'), {download:`worklog-${new Date().toISOString().slice(0,10)}.json`, href:URL.createObjectURL(blob)})
      a.click(); URL.revokeObjectURL(a.href)
    })

    // Import JSON
    $('importJson').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]
      if(!file) return
      const reader = new FileReader()
      reader.onload = () => {
        try{
          const list = JSON.parse(String(reader.result))
          if(!Array.isArray(list)) throw new Error('Invalid JSON')
          // merge by id
          const map = new Map(state.entries.map(x=>[x.id,x]))
          for(const x of list){ map.set(x.id || uid(), {...x, id: x.id || uid()}) }
          state.entries = [...map.values()]
          saveLocal(); render()
        }catch(err){ alert('Import failed: '+ err.message) }
      }
      reader.readAsText(file)
      e.target.value = ''
    })

    // Clear all
    $('clearAll').addEventListener('click', ()=>{
      if(!confirm('This will delete ALL saved entries. Continue?')) return
      state.entries = []
      saveLocal(); render(); resetForm()
    })

    // First render
    render()
  })()
  </script>
</body>
</html>

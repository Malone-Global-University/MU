<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Letter Primer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root { --bg:#fff; --fg:#000; --dash:#888; }
    body { font-family:sans-serif; background:var(--bg); color:var(--fg); }
    .toolbar { padding:.5rem; text-align:right; border-bottom:1px solid #ccc; }
    .book { max-width:800px; margin:auto; padding:1rem; }
    .page { margin-bottom:2rem; }
    .foot { text-align:center; font-size:.9rem; margin-top:1rem; }
    h2 { margin-bottom:.5rem; }
    .emoji-xl { font-size:6rem; }
    .text-highlight { font-weight:bold; }
    .trace { width:200px; height:240px; }
    .trace text {
      font-size:200px; font-weight:800; fill:none;
      stroke:var(--dash); stroke-width:6; stroke-dasharray:10 12;
    }
    .trace text.lower { font-size:150px; }
    .fill .word { display:inline-block; margin:.25rem; padding:.25rem .5rem; border:1px solid #ccc; cursor:pointer; }
    canvas { border:1px solid #ccc; width:100%; height:200px; }
  </style>
</head>
<body>
  <div class="toolbar">
    <button onclick="toggleBG()">Toggle Background</button>
  </div>

  <div class="book" id="book"></div>

  <script>
    // Load JSON
    async function loadData() {
      const res = await fetch("primers.json");
      return res.json();
    }

    // Get letter from URL
    const urlParams = new URLSearchParams(window.location.search);
    const LETTER = urlParams.get("letter")?.toUpperCase() || "A";

    // Render book
    loadData().then(data => {
      const lesson = data[LETTER];
      if (!lesson) return;

      const book = document.getElementById("book");

      // Page 1: Trace
      book.innerHTML += `
        <div class="page">
          <h2>Trace the Letter ${LETTER}</h2>
          <div class="handwriting">
            <svg class="trace" viewBox="0 0 200 240"><text x="50%" y="70%" dominant-baseline="middle" text-anchor="middle">${LETTER}</text></svg>
            <svg class="trace" viewBox="0 0 200 240"><text class="lower" x="50%" y="70%" dominant-baseline="middle" text-anchor="middle">${LETTER.toLowerCase()}</text></svg>
          </div>
          <div class="foot">Page 1</div>
        </div>`;

      // Page 2: Emojis
      book.innerHTML += `
        <div class="page">
          <h2>Art with ${LETTER}</h2>
          <div class="emoji-xl">${lesson.emojis.join(" ")}</div>
          <figcaption>${lesson.words.join(", ")}</figcaption>
          <div class="foot">Page 2</div>
        </div>`;

      // Page 3: Fill
      book.innerHTML += `
        <div class="page fill">
          <h2>Fill in the ${LETTER} Words</h2>
          <div>${lesson.words.map(w => `<span class="word" onclick="checkFill(this)">${w}</span>`).join("")}</div>
          <div class="foot">Page 3</div>
        </div>`;

      // Page 4: Story
      const story = lesson.story.replace(new RegExp(`(${LETTER}|${LETTER.toLowerCase()})`, "g"), `<span class="text-highlight" style="color:${lesson.color}">$1</span>`);
      book.innerHTML += `
        <div class="page">
          <h2>${LETTER} Story</h2>
          <p>${story}</p>
          <div class="foot">Page 4</div>
        </div>`;

      // Page 5: Match
      book.innerHTML += `
        <div class="page match">
          <h2>Match the ${LETTER} Words</h2>
          ${lesson.emojis.map((e,i)=>`<div class="pair">${e} â†’ ${lesson.words[i]}</div>`).join("")}
          <div class="foot">Page 5</div>
        </div>`;

      // Page 6: Draw
      book.innerHTML += `
        <div class="page drawbox">
          <h2>Draw Something with ${LETTER}</h2>
          <canvas id="draw"></canvas>
          <div class="foot">Page 6</div>
        </div>`;
      
      initDraw();
    });

    // BG toggle
    function toggleBG(){
      document.body.style.background =
        document.body.style.background === "black" ? "white" : "black";
      document.body.style.color =
        document.body.style.background === "black" ? "white" : "black";
    }

    // Fill word check
    function checkFill(el) {
      el.style.background = "lightgreen";
      const utter = new SpeechSynthesisUtterance(el.textContent);
      speechSynthesis.speak(utter);
    }

    // Drawing
    function initDraw(){
      const canvas = document.getElementById("draw");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      let drawing = false;
      canvas.addEventListener("mousedown",()=>drawing=true);
      canvas.addEventListener("mouseup",()=>drawing=false);
      canvas.addEventListener("mousemove",e=>{
        if (!drawing) return;
        ctx.fillRect(e.offsetX,e.offsetY,2,2);
      });
    }
  </script>
</body>
</html>